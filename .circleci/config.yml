version: 2.1

jobs:
  docker-on-macos:
    macos:
      xcode: "26.2.0"
    
    steps:
      - checkout
      
      - run:
          name: Install dependencies
          command: |
            brew install lima qemu expect
      
      - run:
          name: Patch QEMU to force TCG mode
          command: |
            # Move real QEMU binary
            sudo mv /opt/homebrew/bin/qemu-system-aarch64 /opt/homebrew/bin/qemu-system-aarch64.real
            
            # Create wrapper that forces TCG instead of HVF
            sudo tee /opt/homebrew/bin/qemu-system-aarch64 \<< 'WRAPPER'
            #!/bin/bash
            args=()
            for arg in "$@"; do
              args+=("${arg//accel=hvf/accel=tcg}")
            done
            exec /opt/homebrew/bin/qemu-system-aarch64.real "${args[@]}"
            WRAPPER
            
            sudo chmod +x /opt/homebrew/bin/qemu-system-aarch64
            echo "✓ QEMU patched to use TCG"
      
      - run:
          name: Create Lima Docker VM
          command: |
            # Use expect to handle interactive prompts
            /usr/bin/expect \<< 'EOF'
            set timeout 300
            spawn limactl create --name=docker-tcg --vm-type=qemu template:docker --tty=false
            expect {
              "Try to sign*" { send "n\r"; exp_continue }
              "Proceed with the current configuration" { send "y\r"; exp_continue }
              eof
            }
            EOF
            
            limactl list
      
      - run:
          name: Start Lima VM
          command: |
            SERIAL_LOG="$HOME/.lima/docker-tcg/serial.log"
            
            # Use expect to handle the signing prompt
            /usr/bin/expect \<< 'EXPECT_SCRIPT' &
            set timeout 1200
            spawn limactl start docker-tcg
            expect {
              "Try to sign*" { send "n\r"; exp_continue }
              "Y/n" { send "n\r"; exp_continue }
              eof
            }
            EXPECT_SCRIPT
            EXPECT_PID=$!
            
            # Wait for serial log to appear
            echo "Waiting for VM to start booting..."
            for i in $(seq 1 120); do
              [ -f "$SERIAL_LOG" ] && break
              sleep 2
            done
            
            if [ -f "$SERIAL_LOG" ]; then
              echo "=== Tailing VM boot log ==="
              tail -f "$SERIAL_LOG" &
              TAIL_PID=$!
            fi
            
            # Wait for Lima to report Running
            for i in $(seq 1 180); do
              if limactl list docker-tcg 2>/dev/null | grep -q "Running"; then
                echo ""
                echo "✓ Lima VM is ready!"
                break
              fi
              sleep 5
            done
            
            # Wait for expect to finish
            wait $EXPECT_PID 2>/dev/null || true
            
            # Kill tail
            kill $TAIL_PID 2>/dev/null || true
            
            # Final check
            if limactl list docker-tcg | grep -q "Running"; then
              echo "✓ VM started successfully"
              limactl list docker-tcg
            else
              echo "ERROR: VM not running"
              cat "$HOME/.lima/docker-tcg/ha.stderr.log" 2>/dev/null || true
              exit 1
            fi
          no_output_timeout: 25m
      
      - run:
          name: Setup Docker
          command: |
            limactl shell docker-tcg -- sudo systemctl start docker
            limactl shell docker-tcg -- sudo systemctl enable docker
            
            docker context create lima-docker-tcg --docker "host=unix://$HOME/.lima/docker-tcg/sock/docker.sock" || true
            docker context use lima-docker-tcg
            
            echo "=== Docker Version ==="
            docker version
      
      - run:
          name: Run Docker container
          command: |
            docker run --rm hello-world
            docker run --rm cimg/base:current uname -a
      
      - run:
          name: Debug logs (on failure)
          command: |
            echo "=== Lima List ==="
            limactl list
            echo "=== ha.stderr.log ==="
            cat "$HOME/.lima/docker-tcg/ha.stderr.log" 2>/dev/null || true
            echo "=== serial.log (last 200 lines) ==="
            tail -200 "$HOME/.lima/docker-tcg/serial.log" 2>/dev/null || true
          when: on_fail
      
      - run:
          name: Cleanup
          command: |
            limactl stop docker-tcg || true
            limactl delete docker-tcg -f || true
          when: always

workflows:
  build:
    jobs:
      - docker-on-macos
