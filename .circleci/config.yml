version: 2.1

jobs:
  docker-on-macos:
    macos:
      xcode: "16.2.0"    
    steps:
      - checkout
      
      - run:
          name: Install Lima and QEMU
          command: |
            brew install lima qemu
      
      - run:
          name: Patch QEMU to force TCG mode
          command: |
            # Move real QEMU binary
            sudo mv /opt/homebrew/bin/qemu-system-aarch64 /opt/homebrew/bin/qemu-system-aarch64.real
            
            # Create wrapper that forces TCG instead of HVF
            sudo tee /opt/homebrew/bin/qemu-system-aarch64 \<< 'WRAPPER'
            #!/bin/bash
            args=()
            for arg in "$@"; do
              args+=("${arg//accel=hvf/accel=tcg}")
            done
            exec /opt/homebrew/bin/qemu-system-aarch64.real "${args[@]}"
            WRAPPER
            
            sudo chmod +x /opt/homebrew/bin/qemu-system-aarch64
            
            echo "✓ QEMU patched to use TCG (software emulation)"
      
      - run:
          name: Create Lima Docker VM
          command: |
            yes | limactl create --name=docker-tcg --vm-type=qemu template:docker --tty=false || true
            limactl list
      
      - run:
          name: Start Lima VM (background)
          command: |
            limactl start docker-tcg
          background: true
      
      - run:
          name: Tail Lima VM boot logs
          command: |
            SERIAL_LOG="$HOME/.lima/docker-tcg/serial.log"
            
            echo "Waiting for VM to start booting..."
            for i in $(seq 1 60); do
              [ -f "$SERIAL_LOG" ] && break
              sleep 2
            done
            
            if [ ! -f "$SERIAL_LOG" ]; then
              echo "ERROR: Serial log not found after 2 minutes"
              echo "=== ha.stderr.log ==="
              cat "$HOME/.lima/docker-tcg/ha.stderr.log" 2>/dev/null || true
              exit 1
            fi
            
            echo "=== Tailing VM boot log ==="
            tail -f "$SERIAL_LOG" &
            TAIL_PID=$!
            
            # Wait for Lima to report Running (check every 10s, max 15 min)
            for i in $(seq 1 90); do
              if limactl list docker-tcg 2>/dev/null | grep -q "Running"; then
                echo ""
                echo "✓ Lima VM is ready!"
                kill $TAIL_PID 2>/dev/null || true
                exit 0
              fi
              sleep 10
            done
            
            echo "ERROR: Lima VM failed to start within 15 minutes"
            kill $TAIL_PID 2>/dev/null || true
            exit 1
          no_output_timeout: 20m
      
      - run:
          name: Setup Docker context
          command: |
            # Enable Docker in the VM
            limactl shell docker-tcg -- sudo systemctl start docker
            limactl shell docker-tcg -- sudo systemctl enable docker
            
            # Create Docker context pointing to Lima socket
            docker context create lima-docker-tcg --docker "host=unix://$HOME/.lima/docker-tcg/sock/docker.sock" || true
            docker context use lima-docker-tcg
            
            echo "=== Docker Version ==="
            docker version
      
      - run:
          name: Run Docker container
          command: |
            docker run --rm hello-world
            docker run --rm cimg/base:current uname -a
      
      - run:
          name: Debug logs (on failure)
          command: |
            echo "=== Lima List ==="
            limactl list
            echo ""
            echo "=== ha.stderr.log ==="
            cat "$HOME/.lima/docker-tcg/ha.stderr.log" 2>/dev/null || true
            echo ""
            echo "=== serial.log (last 200 lines) ==="
            tail -200 "$HOME/.lima/docker-tcg/serial.log" 2>/dev/null || true
          when: on_fail
      
      - run:
          name: Cleanup
          command: |
            limactl stop docker-tcg || true
            limactl delete docker-tcg -f || true
          when: always

workflows:
  build:
    jobs:
      - docker-on-macos
