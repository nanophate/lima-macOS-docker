# CircleCI config for running Docker on macOS using Lima + QEMU TCG
# Use this when hardware virtualization is unavailable (e.g., macOS VMs)

version: 2.1

jobs:
  docker-on-macos:
    macos:
      xcode: "26.2.0" 
    
    steps:
      - checkout
      
      - run:
          name: Install dependencies (lima, qemu, expect)
          command: |
            export PATH="/opt/homebrew/bin:$PATH"
            brew install lima qemu expect
      
      - run:
          name: Setup QEMU wrapper for TCG mode
          command: |
            export PATH="/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:$PATH"
            
            # Move original QEMU binary if not already done
            if [[ ! -f /opt/homebrew/bin/qemu-system-aarch64.real ]]; then
                sudo mv /opt/homebrew/bin/qemu-system-aarch64 /opt/homebrew/bin/qemu-system-aarch64.real
            fi
            
            # Create wrapper that forces TCG (software emulation instead of HVF)
            sudo tee /opt/homebrew/bin/qemu-system-aarch64 > /dev/null \<< 'WRAPPER'
            #!/bin/bash
            args=()
            for arg in "$@"; do
              args+=("${arg//accel=hvf/accel=tcg}")
            done
            exec /opt/homebrew/bin/qemu-system-aarch64.real "${args[@]}"
            WRAPPER
            sudo chmod +x /opt/homebrew/bin/qemu-system-aarch64
      
      - run:
          name: Create Lima Docker VM
          no_output_timeout: 10m
          command: |
            export PATH="/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:$PATH"
            
            # Use expect to handle interactive prompts (QEMU signing, config confirmation)
            /usr/bin/expect \<< 'EXPECT_SCRIPT'
            set timeout 600
            spawn limactl create --name=docker-tcg --vm-type=qemu template:docker --tty=false
            expect {
                -re "Try to sign.*\\?" { send "y\r"; exp_continue }
                -re "\\(Y/n\\)" { send "y\r"; exp_continue }
                -re "Proceed with the current configuration.*\\?" { send "y\r"; exp_continue }
                timeout { 
                    puts "ERROR: Timeout during limactl create"
                    exit 1 
                }
                eof
            }
            catch wait result
            set exit_code [lindex $result 3]
            puts "limactl create exited with code: $exit_code"
            exit $exit_code
            EXPECT_SCRIPT
      
      - run:
          name: Start Lima Docker VM
          no_output_timeout: 15m
          command: |
            export PATH="/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:$PATH"
            
            /usr/bin/expect \<< 'EXPECT_SCRIPT'
            set timeout 900
            spawn limactl start docker-tcg --tty=false
            expect {
                -re "Try to sign.*\\?" { send "y\r"; exp_continue }
                -re "\\(Y/n\\)" { send "y\r"; exp_continue }
                -re "Proceed with the current configuration.*\\?" { send "y\r"; exp_continue }
                timeout { 
                    puts "ERROR: Timeout during limactl start"
                    exit 1 
                }
                eof
            }
            catch wait result
            set exit_code [lindex $result 3]
            puts "limactl start exited with code: $exit_code"
            exit $exit_code
            EXPECT_SCRIPT
      
      - run:
          name: Verify Lima VM is running
          command: |
            export PATH="/opt/homebrew/bin:$PATH"
            limactl list
            
            # Wait for VM to be fully ready
            for i in {1..30}; do
              if limactl shell docker-tcg docker version > /dev/null 2>&1; then
                echo "Docker is ready!"
                break
              fi
              echo "Waiting for Docker... ($i/30)"
              sleep 10
            done
      
      - run:
          name: Setup Docker context
          command: |
            export PATH="/opt/homebrew/bin:$PATH"
            
            # Create Docker context pointing to Lima VM
            docker context create lima-docker-tcg \
              --docker "host=unix://$HOME/.lima/docker-tcg/sock/docker.sock" || true
            docker context use lima-docker-tcg
      
      - run:
          name: Test Docker
          command: |
            export PATH="/opt/homebrew/bin:$PATH"
            
            echo "=== Docker Version ==="
            docker version
            
            echo "=== Running hello-world ==="
            docker run --rm hello-world
      
      # Your actual Docker commands go here
      - run:
          name: Run your Docker commands
          command: |
            export PATH="/opt/homebrew/bin:$PATH"
            
            # Example: Build and run a container
            # docker build -t myapp .
            # docker run --rm myapp
            
            echo "Add your Docker commands here"
      
      - run:
          name: Cleanup Lima VM
          when: always
          command: |
            export PATH="/opt/homebrew/bin:$PATH"
            limactl stop docker-tcg --force || true
            limactl delete docker-tcg --force || true

workflows:
  docker-workflow:
    jobs:
      - docker-on-macos
